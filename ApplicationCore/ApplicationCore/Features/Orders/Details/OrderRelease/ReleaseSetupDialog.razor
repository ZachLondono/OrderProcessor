@using ApplicationCore.Features.Companies.Domain.ValueObjects;
@using ApplicationCore.Features.Orders.Details.OrderRelease;
@using static ApplicationCore.Features.Shared.Components.Button;
@using ApplicationCore.Features.Orders.Details.OrderRelease.Handlers.CNC.LabelDB;
@using ApplicationCore.Features.Orders.Details.OrderRelease.Handlers.CNC.LabelDB.Contracts;
@using ApplicationCore.Features.Shared.Components
@using ApplicationCore.Features.Shared.Services;
@inject IFilePicker FilePicker


@if (Configuration is null) {
    <span>Loading...</span>    
} else {

    <div class="flex flex-col space-y-5">

        @if(_errorMessage is not null) {
            
            <section>
                <span class="text-red-600">@_errorMessage</span>
            </section>

        }

        <section>
            <CheckBox @bind-IsChecked="Configuration.GenerateCNCRelease">
                <span class="text-gray-700">Generate CNC Release PDF</span>
            </CheckBox>
            <div class="flex justify-center items-center mt-3">
                <Button OnClickAsync="ChooseCNCDataFile" Color="ButtonColor.Secondary">Select File</Button> <span class="text-sm px-3">@(string.IsNullOrWhiteSpace(Configuration.CNCDataFilePath) ? "No File Selected" : TruncateString(Configuration.CNCDataFilePath))</span>
            </div>
            @if (Configuration.CNCJobs is not null) {
                <table class="table-auto justify-center mx-auto my-3">
                    <thead class="border-b border-slate-300">
                        <tr class="dark:bg-slate-700">
                            <th class="text-sm">Name</th>
                            <th class="text-sm">Machine</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var job in Configuration.CNCJobs) {
                            <tr class="justify-center hover:bg-slate-200 ">
                                <td class="p-3 border-b text-sm">@job.Name</td>
                                <td class="p-3 border-b text-sm">@job.MachineName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </section>

        <section>
            <CheckBox @bind-IsChecked="Configuration.GeneratePackingList">
                <span class="text-gray-700">Generate Packing List</span>
            </CheckBox>
            <CheckBox @bind-IsChecked="Configuration.GenerateInvoice">
                <span class="text-gray-700">Generate Invoice</span>
            </CheckBox>
        </section>

        <section>
            <CheckBox @bind-IsChecked="Configuration.GenerateJobSummary">
                <span class="text-gray-700">Generate Job Summary</span>
            </CheckBox>
            <label class="block text-sm font-medium text-gray-700">Template</label>
            <input type="text" class="mt-1 w-full" @bind="@Configuration.JobSummaryTemplate" />
        </section>

        <section>
            <CheckBox @bind-IsChecked="Configuration.SendEmail">
                <span class="text-gray-700">Send Email</span>
            </CheckBox>
            <label class="block text-sm font-medium text-gray-700">Email Recipients</label>
            <input type="text" class="mt-1 w-full" @bind="@Configuration.EmailRecipients" />
        </section>

        <section>
            <input type="text" class="mt-1 w-full" @bind="@Configuration.OutputDirectory" />
        </section>

        <section>
            <Button Color="ButtonColor.Primary" Style="ButtonStyle.Text" OnClickAsync="Release">Release</Button>
            <Button Color="ButtonColor.Secondary" Style="ButtonStyle.Text" OnClickAsync="Cancel">Cancel</Button>
        </section>

    </div>
}

@code {

    [CascadingParameter]
    private BlazoredModalInstance ModalInstance { get; set; } = default!;

    [CascadingParameter]
    public IModalService ModalService { get; set; } = default!;

    public ReleaseConfiguration? Configuration { get; set; } = new();
    private string? _errorMessage = null;

    private async Task ChooseCNCDataFile() {

        if (Configuration is null) return;

        var waitingDialog = ShowLoadingDialog("Waiting", "Select Label File.");

        string selectedPath = "";
        bool wasPicked = await FilePicker.PickFileAsync("Select CADCode Label Data File", "C:\\", new("CADCode Label Database", "mdb"), (file) => {
            selectedPath = file;
        });

        waitingDialog.Close();

        if (!wasPicked || selectedPath == "") {
            return;
        }

        var modal = ModalService.Show<ListAvailableJobsDialog>("Select Job", new ModalParameters() { { "LabelDatabaseFilePath", selectedPath } });
        var modalResult = await modal.Result;
        if (modalResult.Cancelled) {
            return;
        }

        if (modalResult.Data is not IEnumerable<AvailableJob> selectedJobs) {
            _ = await ModalService.OpenInformationDialog("Error", "Unexpected Data Returned", InformationDialog.MessageType.Warning);
            return;
        }

        Configuration.CNCDataFilePath = selectedPath;
        Configuration.CNCJobs = selectedJobs;
        StateHasChanged();

    }
    
    private IModalReference ShowLoadingDialog(string title, string message) {

        var options = new ModalOptions() {
                HideHeader = true,
                HideCloseButton = true,
                DisableBackgroundCancel = true
            };

        return ModalService.Show<InformationDialog>("", options: options, parameters: new ModalParameters {
            { "Type", InformationDialog.MessageType.Information },
            { "Title", title},
            { "Details", message }
        });

    }

    private string TruncateString(string value) {

        if (value.Length < 50) return value;

        return $"...{value[(value.Length - 27)..]}";

    }

    private async Task Cancel() {

        await ModalInstance.CancelAsync();

    }

    private async Task Release() {

        _errorMessage = null;

        if (Configuration is null) {
            _errorMessage = "Could not load release configuration";
            return;
        }

        var parameters = new ModalParameters() {
            { "Configuration",  Configuration }
        };

        var options = new ModalOptions() {
                HideHeader = true,
                HideCloseButton = true,
                DisableBackgroundCancel = true,
                Size = ModalSize.Large
            };

        var dialog = ModalService.Show<ReleaseProgressDialog>("Order Release Progress", parameters, options);

        _ = await dialog.Result;

        await ModalInstance.CloseAsync();
    }

}
