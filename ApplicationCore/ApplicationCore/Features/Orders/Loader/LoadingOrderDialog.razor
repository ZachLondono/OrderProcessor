@using ApplicationCore.Features.Orders.Loader.Providers;
@using ApplicationCore.Infrastructure;
@using ApplicationCore.Shared.Components
@using static ApplicationCore.Shared.Components.Button
@inject NavigationManager NavigationManager
@inject OrderState OrderState
@inject IOrderProviderFactory Factory
@inject IBus Bus
@inject IJSRuntime JSRuntime
@inherits BaseListenerComponent
@implements IUIListener<OrderLoadMessage>

@switch (_state) {
    case State.Loading:

        <span>Loading</span>
        break;

    case State.Complete:

        <span>Complete</span>
        break;

    case State.Error:
        
        <span>Error</span>
        break;

    default:
        <!-- Empty -->
        break;
}

@if (_messages.Any()) {

    <div class="shadow-md max-h-48 w-full overflow-x-hidden overflow-y-scroll p-1.5 border border-gray-200" @ref="_messagebox">
        <table class="w-full border-collapse text-xs">
            <tr>
                <td colspan="2" class="text-[0.5rem] italic">
                    Progress Log
                </td>
            </tr>

            @foreach (var message in _messages) {
                <tr class="border-b border-gray-100">
                    <td class="w-4">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-4 h-4">
                            @switch (message.Severity) {
                                case MessageSeverity.Warning:
                                    <path class="text-yellow-700" stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                    break;

                                case MessageSeverity.Error:
                                    <path class="text-red-700" stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    break;

                                default:
                                    break;
                            }
                        </svg>
                    </td>
                    <td class="text-overflow-ellipsis">@message.Message</td>
                </tr>
            }
        </table>
    </div>

}

@if (_state == State.Complete) {
    <Button Style="ButtonStyle.Text" Color="ButtonColor.Success" OnClickAsync="OpenOrderDetails" Class="mt-3 float-right mr-3">Open Order</Button>
}
<Button Style="ButtonStyle.Text" Color="ButtonColor.Secondary" Disabled="@(_state != State.Complete && _state != State.Error)" OnClickAsync="CloseDialog" Class="mt-3 float-right">Close</Button>


@code {

    [CascadingParameter]
    private BlazoredModalInstance BlazoredModal { get; set; } = default!;

    [Parameter]
    public OrderSourceType SourceType { get; set; }
    [Parameter]
    public string Source { get; set; } = string.Empty;

    private State _state = State.Loading;
    private List<OrderLoadMessage> _messages = new();
    private ElementReference _messagebox;

    protected override async Task OnAfterRenderAsync(bool firstRender) {

        if (!firstRender) return;

        var data = await Bus.Send(new LoadOrderCommand.Command(SourceType, Source));

        data.Match(
            order => {

                OrderState.ReplaceOrder(order);
                _state = State.Complete;

            },
            error => {

                // TODO: display error
                _state = State.Error;

            }
        );

        StateHasChanged();

    }


    public void Handle(OrderLoadMessage message) {
        _messages.Add(message);
        InvokeAsync(StateHasChanged);
        JSRuntime.InvokeVoidAsync("scrollToEnd", new object[] { _messagebox });
    }

    private async Task CloseDialog() {
        await BlazoredModal.CloseAsync();
    }

    private async Task OpenOrderDetails() {
        await BlazoredModal.CloseAsync();
        NavigationManager.NavigateTo("/orders/details", true);
    }

    private enum State {
        Unknown,
        Loading,
        Complete,
        Error
    }

}
