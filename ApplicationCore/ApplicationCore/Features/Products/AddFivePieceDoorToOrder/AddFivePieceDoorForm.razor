@using Domain.Components
@using Domain.Infrastructure.Bus
@using Domain.ValueObjects
@using MediatR
@using static Domain.Components.Button

@if (_error is not null) {
    <p class="text-red-600">@_error</p>   
}

<EditForm Model="Model">

    <div>
        <label>
            Qty
            <InputNumber @bind-Value="Model.Qty" />
        </label>
    </div>

    <div>
        <label>
            Unit Price
            <InputNumber @bind-Value="Model.UnitPrice" />
        </label>
    </div>

    <div>
        <label>
            Product Number
            <InputNumber @bind-Value="Model.ProductNumber" />
        </label>
    </div>

    <div>
        <label>
            Room
            <InputText @bind-Value="Model.Room" />
        </label>
    </div>

    <div>
        <label>
            Width
            <InputNumber @bind-Value="Model.Width" />
        </label>
    </div>

    <div>
        <label>
            Height
            <InputNumber @bind-Value="Model.Height" />
        </label>
    </div>

    <div>
        <label>
            Stiles
            <InputNumber @bind-Value="Model.Stiles" />
        </label>
    </div>

    <div>
        <label>
            Rails
            <InputNumber @bind-Value="Model.Rails" />
        </label>
    </div>

    <div>
        <label>
            Material
            <InputText @bind-Value="Model.Material" />
        </label>
    </div>

    <Button Type="submit" Color="ButtonColor.Primary" OnClickAsync="AddProductToOrder">Add</Button>
    <Button Color="ButtonColor.Danger" OnClickAsync="Cancel">Cancel</Button>

</EditForm>

@code {

    [Inject]
    public IBus Bus { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public Guid OrderId { get; set; }

    [Parameter]
    public string Room { get; set; } = string.Empty;

    [CascadingParameter]
    public BlazoredModalInstance ModalInstance { get; set; } = default!;

    private NewFivePieceDoorProduct Model { get; } = new();

    private string? _error = null;

    protected override void OnInitialized() {

        if (Room is not null) {
            Model.Room = Room;
        }

        base.OnInitialized();

    }

    public Task Cancel() => ModalInstance.CancelAsync();

    public async Task AddProductToOrder() {

        _error = null;

        var result = await Bus.Send(new InsertFivePieceDoorProductInOrder.Command(OrderId, Model));

        await result.Match(
            door => ModalInstance.CloseAsync(ModalResult.Ok(door)),
            error => {
                _error = error.Title;
                return Task.CompletedTask;
            }
        );

    }

}
