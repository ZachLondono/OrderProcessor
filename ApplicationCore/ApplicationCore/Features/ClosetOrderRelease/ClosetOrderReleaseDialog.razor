@using ApplicationCore.Features.ClosetOrderSelector
@using ApplicationCore.Features.GetJobCutListDirectory
@using Domain.Components
@using Domain.Components.ProgressModal
@using Domain.Infrastructure.Bus
@using Domain.Services

<EditForm Model="Model">

    <div>
        <label class="font-semibold">Workbook -</label>
        <span class="ml-5">@Model.WorkbookFilePath</span>

        <div class="ml-5 text-sm text-gray-700">
            <div>
                <label>
                    <InputCheckbox @bind-Value="Model.IncludeCover" />
                    Cover
                </label>
            </div>
            <div>
                <label>
                    <InputCheckbox @bind-Value="Model.IncludePackingList" />
                    Packing List
                </label>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <label>
            <InputCheckbox @bind-Value="Model.AddExistingWSXMLReport" />
            <span class="text-gray-700">Existing GCode (WSXML)</span>
        </label>
        @if (Model.AddExistingWSXMLReport) {
            <div>
                <Button Color="Button.ButtonColor.Secondary" OnClick="ChooseReportFile" Class="mr-5">Choose Report</Button>
                @if (string.IsNullOrEmpty(Model.WSXMLReportFilePath)) {
                    <span>None selected</span>
                } else {
                    <span>@Model.WSXMLReportFilePath</span>
                }
            </div>
        }
    </div>

    <div class="mt-3">
        <label>
            <span class="text-gray-700">
                File Name
            </span>
            <InputText @bind-Value="Model.FileName" class="input-text w-full" spellcheck="false" />
        </label>
    </div>

    <div class="mt-3">
        <label >
            <span class="text-gray-700">
                Output Directory
            </span>
            <InputText @bind-Value="Model.OutputDirectory" class="input-text w-full" spellcheck="false" />
        </label>
    </div>

    <div class="mt-3">
        <label class="font-semibold">
            <InputCheckbox @bind-Value="Model.SendEmail" />
            <span class="text-gray-700">Send Email</span>
        </label>
        @if (Model.SendEmail) {
            <div class="ml-3">
                <div>
                    <label>
                        <InputCheckbox @bind-Value="Model.PreviewEmail" />
                        <span class="text-gray-700 text-sm">Preview email before sending</span>
                    </label>
                </div>
                <label>
                    <span class="text-sm font-medium text-gray-700">Email Recipients</span>
                    <InputText @bind-Value="Model.EmailRecipients" class="input-text w-full" placeholder="example@email.com" />
                </label>
            </div>
        }
    </div>

    <div class="my-5 text-center">
        <Button Color="Button.ButtonColor.Primary" class="mt-3" OnClickAsync="GenerateClosetOrderRelease">Generate PDF</Button>
    </div>

</EditForm>

@code {

    [Parameter]
    public ClosetOrder? Order { get; set; }

    [CascadingParameter]
    public IModalService Modal { get; set; } = default!;

    [CascadingParameter]
    public BlazoredModalInstance BlazoredModal { get; set; } = default!;

    [Inject]
    public IBus? Bus { get; set; }

    [Inject]
    public ClosetOrderReleaseActionRunnerFactory? ActionRunnerFactory { get; set; }

    [Inject]
    public IFilePicker? FilePicker { get; set; }

    public ClosetOrderReleaseOptions Model { get; set; } = new();

    protected override async Task OnInitializedAsync() {

        if (Order is null || Bus is null) return;

        string outputDirectory = @"X:\_CUTLISTS  Incoming";

        var outputDirResult = await Bus.Send(new GetJobOrderCutListDirectory.Query(Order.OrderFileDirectory, ""));
        outputDirResult.OnSuccess(dir => {
            if (string.IsNullOrWhiteSpace(dir)) return;
            outputDirectory += ";" + dir;
        });

        string emailRecipients = "maciej@royalcabinet.com;purchasing@royalcabinet.com";

        Model = new ClosetOrderReleaseOptions() {

            WorkbookFilePath = Order.OrderFile,

            AddExistingWSXMLReport = false, // TODO: try to find wsxml file automatically
            WSXMLReportFilePath = "",

            FileName = $"{Order.OrderNumber} - Closet Cut List",
            OutputDirectory = outputDirectory,

            IncludeCover = true,
            IncludePackingList = true,

            SendEmail = true,
            PreviewEmail = false,
            EmailRecipients = emailRecipients

        };

        StateHasChanged();

        var file = await GetReportFile(Order.OrderNumber);
        Model.WSXMLReportFilePath = file ?? ""; // TODO: allow for multiple files
        Model.AddExistingWSXMLReport = file is not null;

    }

    private static async Task<string?> GetReportFile(string number) {
        return await Task.Run(() => {
            try {

                var files = Directory.GetFiles(@"Y:\CADCode\Reports\", $"{number}*.xml");
                return files.OrderByDescending(file => new FileInfo(file).LastWriteTime)
                            .FirstOrDefault();

            } catch {
                return null;
            }
        });
    }

    private void ChooseReportFile()
        => FilePicker!.PickFile(new() {
                Title = "Select CADCode WS Report File",
                InitialDirectory = @"Y:\CADCode\Reports",
                Filter = new("CADCode WS Report", "xml"),
            }, (fileName) => {
            Model.WSXMLReportFilePath = fileName;
            InvokeAsync(StateHasChanged);
        });

    private async Task GenerateClosetOrderRelease() {

        if (ActionRunnerFactory is null || Order is null) return;

		var actionRunner = ActionRunnerFactory.CreateActionRunner(Order, Model);

		var parameters = new ModalParameters() {
            { "ActionRunner",  actionRunner },
            { "InProgressTitle", "Releasing Order..." },
            { "CompleteTitle", "Release Complete" }
        };

		var options = new ModalOptions() {
            HideHeader = true,
            HideCloseButton = true,
            DisableBackgroundCancel = true,
            Size = ModalSize.Large
        };

		var dialog = Modal.Show<ProgressModal>("Order Release Progress", parameters, options);
		_ = await dialog.Result;
        
        await BlazoredModal.CloseAsync();

	}

}
